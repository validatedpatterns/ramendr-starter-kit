apiVersion: batch/v1
kind: Job
metadata:
  name: odf-dr-prerequisites-checker
  namespace: open-cluster-management
  labels:
    app.kubernetes.io/name: odf-dr-prerequisites
    app.kubernetes.io/component: health-check
  annotations:
    argocd.argoproj.io/sync-wave: "5"
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: prerequisites-checker
        image: registry.redhat.io/openshift4/ose-cli:latest
        command:
        - /bin/bash
        - -c
        - |
          set -euo pipefail
          
          echo "Starting ODF DR prerequisites check..."
          
          # Configuration
          HUB_CLUSTER="local-cluster"
          PRIMARY_CLUSTER="ocp-primary"
          SECONDARY_CLUSTER="ocp-secondary"
          KUBECONFIG_DIR="/tmp/kubeconfigs"
          MAX_ATTEMPTS=60
          SLEEP_INTERVAL=30
          
          # Create kubeconfig directory
          mkdir -p "$KUBECONFIG_DIR"
          
          # Function to check if a condition is met
          check_condition() {
            local condition_name="$1"
            local check_command="$2"
            local cluster="$3"
            
            echo "Checking $condition_name on $cluster..."
            if eval "$check_command"; then
              echo "‚úÖ $condition_name is healthy on $cluster"
              return 0
            else
              echo "‚ùå $condition_name is not healthy on $cluster"
              return 1
            fi
          }
          
          # Function to check Submariner health and connectivity
          check_submariner_health() {
            local cluster="$1"
            local kubeconfig="$2"
            
            echo "Checking Submariner health on $cluster..."
            
            # Check if Submariner is installed
            if ! oc --kubeconfig="$kubeconfig" get crd submariners.submariner.io &>/dev/null; then
              echo "Submariner CRD not found on $cluster"
              return 1
            fi
            
            # Check if Submariner is ready
            local submariner_status=$(oc --kubeconfig="$kubeconfig" get submariner -n submariner-operator -o jsonpath='{.items[0].status.connectionStatus}' 2>/dev/null || echo "NotReady")
            if [[ "$submariner_status" != "Connected" ]]; then
              echo "Submariner connection status on $cluster: $submariner_status"
              return 1
            fi
            
            # Check Submariner gateway nodes
            local gateway_nodes=$(oc --kubeconfig="$kubeconfig" get nodes -l submariner.io/gateway=true --no-headers 2>/dev/null | wc -l)
            if [[ $gateway_nodes -eq 0 ]]; then
              echo "No Submariner gateway nodes found on $cluster"
              return 1
            fi
            
            echo "Submariner is healthy on $cluster"
            return 0
          }
          
          # Function to check Submariner connectivity between clusters
          check_submariner_connectivity() {
            echo "Checking Submariner connectivity between ocp-primary and ocp-secondary..."
            
            # Check Submariner clusters on hub cluster
            local primary_cluster_id=$(oc get clusters.submariner.io ocp-primary -n resilient-broker -o jsonpath='{.spec.cluster_id}' 2>/dev/null || echo "")
            local secondary_cluster_id=$(oc get clusters.submariner.io ocp-secondary -n resilient-broker -o jsonpath='{.spec.cluster_id}' 2>/dev/null || echo "")
            
            if [[ -z "$primary_cluster_id" || -z "$secondary_cluster_id" ]]; then
              echo "Could not retrieve cluster IDs from Submariner"
              return 1
            fi
            
            echo "Primary cluster ID: $primary_cluster_id"
            echo "Secondary cluster ID: $secondary_cluster_id"
            
            # Check if both clusters are registered in Submariner
            if [[ "$primary_cluster_id" == "ocp-primary" && "$secondary_cluster_id" == "ocp-secondary" ]]; then
              echo "‚úÖ Both clusters are registered in Submariner"
              return 0
            else
              echo "‚ùå Cluster IDs do not match expected values"
              return 1
            fi
            
            echo "‚úÖ Submariner connectivity verified between ocp-primary and ocp-secondary"
            return 0
          }
          
          # Function to check ODF health
          check_odf_health() {
            local cluster="$1"
            local kubeconfig="$2"
            
            echo "Checking ODF health on $cluster..."
            
            # Check if ODF is installed
            if ! oc --kubeconfig="$kubeconfig" get crd storageclusters.ocs.openshift.io &>/dev/null; then
              echo "ODF CRD not found on $cluster"
              return 1
            fi
            
            # Check ODF storage cluster status
            local storage_cluster_status=$(oc --kubeconfig="$kubeconfig" get storagecluster -n openshift-storage -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "Unknown")
            if [[ "$storage_cluster_status" != "Ready" ]]; then
              echo "ODF storage cluster status on $cluster: $storage_cluster_status"
              return 1
            fi
            
            # Check ODF operator health
            local odf_operator_status=$(oc --kubeconfig="$kubeconfig" get pods -n openshift-storage -l app.kubernetes.io/name=odf-operator --no-headers 2>/dev/null | grep -c "Running" || echo "0")
            odf_operator_status=$(echo "$odf_operator_status" | tr -d ' \n')
            if [[ $odf_operator_status -eq 0 ]]; then
              echo "ODF operator not running on $cluster"
              return 1
            fi
            
            echo "ODF is healthy on $cluster"
            return 0
          }
          
          # Function to check CA configuration
          check_ca_configuration() {
            local cluster="$1"
            local kubeconfig="$2"
            
            echo "Checking CA configuration on $cluster..."
            
            # Check if cluster-proxy-ca-bundle ConfigMap exists
            if ! oc --kubeconfig="$kubeconfig" get configmap cluster-proxy-ca-bundle -n openshift-config &>/dev/null; then
              echo "cluster-proxy-ca-bundle ConfigMap not found on $cluster"
              return 1
            fi
            
            # Check if ConfigMap has certificate data
            local ca_bundle_size=$(oc --kubeconfig="$kubeconfig" get configmap cluster-proxy-ca-bundle -n openshift-config -o jsonpath='{.data.ca-bundle\.crt}' 2>/dev/null | wc -c || echo "0")
            ca_bundle_size=$(echo "$ca_bundle_size" | tr -d ' \n')
            if [[ $ca_bundle_size -lt 100 ]]; then
              echo "CA bundle is too small or empty on $cluster (size: $ca_bundle_size)"
              return 1
            fi
            
            # Check if Proxy object is configured
            local proxy_trusted_ca=$(oc --kubeconfig="$kubeconfig" get proxy cluster -o jsonpath='{.spec.trustedCA.name}' 2>/dev/null || echo "")
            if [[ "$proxy_trusted_ca" != "cluster-proxy-ca-bundle" ]]; then
              echo "Proxy trustedCA not configured correctly on $cluster (current: $proxy_trusted_ca)"
              return 1
            fi
            
            echo "CA configuration is correct on $cluster"
            return 0
          }
          
          # Function to check CA material completeness across all clusters
          check_ca_material_completeness() {
            local hub_kubeconfig="$1"
            local primary_kubeconfig="$2"
            local secondary_kubeconfig="$3"
            
            echo "Checking CA material completeness across all clusters..."
            
            # Extract CA bundle from each cluster
            local hub_ca_bundle=$(oc --kubeconfig="$hub_kubeconfig" get configmap cluster-proxy-ca-bundle -n openshift-config -o jsonpath='{.data.ca-bundle\.crt}' 2>/dev/null || echo "")
            local primary_ca_bundle=$(oc --kubeconfig="$primary_kubeconfig" get configmap cluster-proxy-ca-bundle -n openshift-config -o jsonpath='{.data.ca-bundle\.crt}' 2>/dev/null || echo "")
            local secondary_ca_bundle=$(oc --kubeconfig="$secondary_kubeconfig" get configmap cluster-proxy-ca-bundle -n openshift-config -o jsonpath='{.data.ca-bundle\.crt}' 2>/dev/null || echo "")
            
            # Check if all CA bundles exist and have reasonable size
            if [[ -z "$hub_ca_bundle" || ${#hub_ca_bundle} -lt 100 ]]; then
              echo "Hub cluster CA bundle is missing or too small"
              return 1
            fi
            
            if [[ -z "$primary_ca_bundle" || ${#primary_ca_bundle} -lt 100 ]]; then
              echo "Primary cluster CA bundle is missing or too small"
              return 1
            fi
            
            if [[ -z "$secondary_ca_bundle" || ${#secondary_ca_bundle} -lt 100 ]]; then
              echo "Secondary cluster CA bundle is missing or too small"
              return 1
            fi
            
            # Check if all CA bundles contain certificates from all three clusters
            # Look for hub cluster certificates
            if [[ "$hub_ca_bundle" != *"# CA from hub-ca"* ]]; then
              echo "Hub cluster CA bundle missing hub-ca certificate"
              return 1
            fi
            
            if [[ "$primary_ca_bundle" != *"# CA from hub-ca"* ]]; then
              echo "Primary cluster CA bundle missing hub-ca certificate"
              return 1
            fi
            
            if [[ "$secondary_ca_bundle" != *"# CA from hub-ca"* ]]; then
              echo "Secondary cluster CA bundle missing hub-ca certificate"
              return 1
            fi
            
            # Look for primary cluster certificates
            if [[ "$hub_ca_bundle" != *"# CA from ocp-primary-ca"* ]]; then
              echo "Hub cluster CA bundle missing ocp-primary-ca certificate"
              return 1
            fi
            
            if [[ "$primary_ca_bundle" != *"# CA from ocp-primary-ca"* ]]; then
              echo "Primary cluster CA bundle missing ocp-primary-ca certificate"
              return 1
            fi
            
            if [[ "$secondary_ca_bundle" != *"# CA from ocp-primary-ca"* ]]; then
              echo "Secondary cluster CA bundle missing ocp-primary-ca certificate"
              return 1
            fi
            
            # Look for secondary cluster certificates
            if [[ "$hub_ca_bundle" != *"# CA from ocp-secondary-ca"* ]]; then
              echo "Hub cluster CA bundle missing ocp-secondary-ca certificate"
              return 1
            fi
            
            if [[ "$primary_ca_bundle" != *"# CA from ocp-secondary-ca"* ]]; then
              echo "Primary cluster CA bundle missing ocp-secondary-ca certificate"
              return 1
            fi
            
            if [[ "$secondary_ca_bundle" != *"# CA from ocp-secondary-ca"* ]]; then
              echo "Secondary cluster CA bundle missing ocp-secondary-ca certificate"
              return 1
            fi
            
            # Check that all CA bundles are identical (they should contain the same combined certificate data)
            if [[ "$hub_ca_bundle" != "$primary_ca_bundle" ]]; then
              echo "Hub and Primary cluster CA bundles are not identical"
              return 1
            fi
            
            if [[ "$hub_ca_bundle" != "$secondary_ca_bundle" ]]; then
              echo "Hub and Secondary cluster CA bundles are not identical"
              return 1
            fi
            
            echo "‚úÖ CA material is complete and consistent across all clusters"
            return 0
          }
          
          # Function to download kubeconfig for a cluster
          download_kubeconfig() {
            local cluster="$1"
            local kubeconfig_path="$KUBECONFIG_DIR/${cluster}-kubeconfig.yaml"
            
            echo "Downloading kubeconfig for $cluster..."
            
            # Special handling for local-cluster (hub cluster)
            if [[ "$cluster" == "local-cluster" ]]; then
              # For hub cluster, create a kubeconfig using the service account token
              local token=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
              
              # Create kubeconfig using printf to avoid heredoc issues
              printf 'apiVersion: v1\nkind: Config\nclusters:\n- cluster:\n    certificate-authority: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n    server: https://kubernetes.default.svc\n  name: hub-cluster\ncontexts:\n- context:\n    cluster: hub-cluster\n    user: service-account\n  name: hub-context\ncurrent-context: hub-context\nusers:\n- name: service-account\n  user:\n    token: %s\n' "$token" > "$kubeconfig_path"
              
              echo "Created kubeconfig for hub cluster using service account"
              return 0
            fi
            
            # Get the kubeconfig secret name (same approach as download-kubeconfigs.sh)
            local kubeconfig_secret=$(oc get secret -n "$cluster" -o name | grep -E "(admin-kubeconfig|kubeconfig)" | head -1)
            
            if [[ -z "$kubeconfig_secret" ]]; then
              echo "No kubeconfig secret found for cluster $cluster"
              return 1
            fi
            
            echo "Found kubeconfig secret: $kubeconfig_secret"
            
            # Try to get the kubeconfig data (same approach as download-kubeconfigs.sh)
            local kubeconfig_data=""
            
            # First try to get the 'kubeconfig' field
            kubeconfig_data=$(oc get "$kubeconfig_secret" -n "$cluster" -o jsonpath='{.data.kubeconfig}' 2>/dev/null | base64 -d 2>/dev/null || echo "")
            
            # If that fails, try the 'raw-kubeconfig' field
            if [[ -z "$kubeconfig_data" ]]; then
              kubeconfig_data=$(oc get "$kubeconfig_secret" -n "$cluster" -o jsonpath='{.data.raw-kubeconfig}' 2>/dev/null | base64 -d 2>/dev/null || echo "")
            fi
            
            if [[ -z "$kubeconfig_data" ]]; then
              echo "Could not extract kubeconfig data for cluster $cluster"
              return 1
            fi
            
            # Write the kubeconfig to file
            echo "$kubeconfig_data" > "$kubeconfig_path"
            
            # Validate kubeconfig
            if oc --kubeconfig="$kubeconfig_path" get nodes --request-timeout=5s &>/dev/null; then
              echo "Kubeconfig downloaded and validated for $cluster"
              return 0
            else
              echo "Kubeconfig for $cluster is invalid or cluster is unreachable"
              return 1
            fi
          }
          
          # Main check loop
          attempt=1
          while [[ $attempt -le $MAX_ATTEMPTS ]]; do
            echo "=== Prerequisites Check Attempt $attempt/$MAX_ATTEMPTS ==="
            
            all_checks_passed=true
            
            # Download kubeconfigs
            if ! download_kubeconfig "$HUB_CLUSTER"; then
              echo "Failed to download kubeconfig for $HUB_CLUSTER"
              all_checks_passed=false
            fi
            
            if ! download_kubeconfig "$PRIMARY_CLUSTER"; then
              echo "Failed to download kubeconfig for $PRIMARY_CLUSTER"
              all_checks_passed=false
            fi
            
            if ! download_kubeconfig "$SECONDARY_CLUSTER"; then
              echo "Failed to download kubeconfig for $SECONDARY_CLUSTER"
              all_checks_passed=false
            fi
            
            if [[ "$all_checks_passed" == "true" ]]; then
              # Check Submariner health on individual clusters
              if ! check_submariner_health "$PRIMARY_CLUSTER" "$KUBECONFIG_DIR/${PRIMARY_CLUSTER}-kubeconfig.yaml"; then
                all_checks_passed=false
              fi
              
              if ! check_submariner_health "$SECONDARY_CLUSTER" "$KUBECONFIG_DIR/${SECONDARY_CLUSTER}-kubeconfig.yaml"; then
                all_checks_passed=false
              fi
              
              # Check Submariner connectivity between clusters
              if ! check_submariner_connectivity "$KUBECONFIG_DIR/${PRIMARY_CLUSTER}-kubeconfig.yaml" "$KUBECONFIG_DIR/${SECONDARY_CLUSTER}-kubeconfig.yaml"; then
                all_checks_passed=false
              fi
              
              # Check ODF health
              if ! check_odf_health "$PRIMARY_CLUSTER" "$KUBECONFIG_DIR/${PRIMARY_CLUSTER}-kubeconfig.yaml"; then
                all_checks_passed=false
              fi
              
              if ! check_odf_health "$SECONDARY_CLUSTER" "$KUBECONFIG_DIR/${SECONDARY_CLUSTER}-kubeconfig.yaml"; then
                all_checks_passed=false
              fi
              
              # Check CA configuration on individual clusters
              if ! check_ca_configuration "$HUB_CLUSTER" "$KUBECONFIG_DIR/${HUB_CLUSTER}-kubeconfig.yaml"; then
                all_checks_passed=false
              fi
              
              if ! check_ca_configuration "$PRIMARY_CLUSTER" "$KUBECONFIG_DIR/${PRIMARY_CLUSTER}-kubeconfig.yaml"; then
                all_checks_passed=false
              fi
              
              if ! check_ca_configuration "$SECONDARY_CLUSTER" "$KUBECONFIG_DIR/${SECONDARY_CLUSTER}-kubeconfig.yaml"; then
                all_checks_passed=false
              fi
              
              # Check CA material completeness across all clusters
              if ! check_ca_material_completeness "$KUBECONFIG_DIR/${HUB_CLUSTER}-kubeconfig.yaml" "$KUBECONFIG_DIR/${PRIMARY_CLUSTER}-kubeconfig.yaml" "$KUBECONFIG_DIR/${SECONDARY_CLUSTER}-kubeconfig.yaml"; then
                all_checks_passed=false
              fi
            fi
            
            if [[ "$all_checks_passed" == "true" ]]; then
              echo "üéâ All prerequisites are met! Proceeding with DR policy deployment..."
              exit 0
            else
              echo "‚ùå Some prerequisites are not met. Waiting $SLEEP_INTERVAL seconds before retry..."
              sleep $SLEEP_INTERVAL
              ((attempt++))
            fi
          done
          
          echo "‚ùå Prerequisites check failed after $MAX_ATTEMPTS attempts"
          echo "Please ensure:"
          echo "1. Submariner is installed and connected between ocp-primary and ocp-secondary"
          echo "2. ODF is installed and healthy on both managed clusters"
          echo "3. CA certificates are properly configured on all three clusters (hub, primary, secondary)"
          echo "4. All clusters have identical CA bundles containing certificates from all three clusters"
          exit 1
      serviceAccountName: odf-dr-prerequisites-checker
