apiVersion: batch/v1
kind: Job
metadata:
  name: odf-ssl-certificate-precheck
  namespace: open-cluster-management
  labels:
    app.kubernetes.io/name: odf-ssl-certificate-management
    app.kubernetes.io/component: certificate-precheck
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  backoffLimit: 3
  template:
    spec:
      serviceAccountName: odf-ssl-certificate-precheck
      restartPolicy: Never
      containers:
      - name: odf-ssl-precheck
        image: registry.redhat.io/openshift4/ose-cli:latest
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
        command:
        - /bin/bash
        - -c
        - |
          set -euo pipefail
          
          echo "Starting ODF SSL certificate precheck and distribution..."
          echo "This job ensures certificates are properly distributed before DR policies are applied"
          
          # Configuration
          MIN_CERTIFICATES=15
          MIN_BUNDLE_SIZE=20000
          MAX_ATTEMPTS=3
          SLEEP_INTERVAL=10
          
          # Function to clean up placeholder ConfigMaps
          cleanup_placeholder_configmaps() {
            echo "üßπ Cleaning up placeholder ConfigMaps from managed clusters..."
            
            MANAGED_CLUSTERS=$(oc get managedclusters -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo "")
            
            if [[ -z "$MANAGED_CLUSTERS" ]]; then
              echo "No managed clusters found"
              return 1
            fi
            
            for cluster in $MANAGED_CLUSTERS; do
              if [[ "$cluster" == "local-cluster" ]]; then
                continue
              fi
              
              echo "Checking $cluster for placeholder ConfigMaps..."
              
              KUBECONFIG_FILE=""
              if oc get secret -n "$cluster" -o name | grep -E "(admin-kubeconfig|kubeconfig)" | head -1 | xargs -I {} oc get {} -n "$cluster" -o jsonpath='{.data.kubeconfig}' | base64 -d > "/tmp/${cluster}-kubeconfig.yaml" 2>/dev/null; then
                KUBECONFIG_FILE="/tmp/${cluster}-kubeconfig.yaml"
              fi
              
              if [[ -n "$KUBECONFIG_FILE" && -f "$KUBECONFIG_FILE" ]]; then
                configmap_content=$(oc --kubeconfig="$KUBECONFIG_FILE" get configmap cluster-proxy-ca-bundle -n openshift-config -o jsonpath='{.data.ca-bundle\.crt}' 2>/dev/null || echo "")
                
                if [[ "$configmap_content" == *"Placeholder for ODF SSL certificate bundle"* ]] || [[ "$configmap_content" == *"This will be populated by the certificate extraction job"* ]]; then
                  echo "  üóëÔ∏è  Deleting placeholder ConfigMap from $cluster..."
                  oc --kubeconfig="$KUBECONFIG_FILE" delete configmap cluster-proxy-ca-bundle -n openshift-config --ignore-not-found=true
                  echo "  ‚úÖ Placeholder ConfigMap removed from $cluster"
                else
                  echo "  ‚úÖ $cluster: No placeholder ConfigMap found"
                fi
              else
                echo "  ‚ùå $cluster: Could not get kubeconfig for cleanup"
              fi
            done
            
            echo "‚úÖ Placeholder ConfigMap cleanup completed"
            return 0
          }
          
          # Function to check certificate distribution
          check_certificate_distribution() {
            echo "Checking certificate distribution status..."
            
            if ! oc get configmap cluster-proxy-ca-bundle -n openshift-config >/dev/null 2>&1; then
              echo "‚ùå CA bundle ConfigMap not found on hub cluster"
              return 1
            fi
            
            bundle_content=$(oc get configmap cluster-proxy-ca-bundle -n openshift-config -o jsonpath="{.data['ca-bundle\.crt']}" 2>/dev/null || echo "")
            
            if [[ -z "$bundle_content" ]]; then
              echo "‚ùå CA bundle is empty"
              return 1
            fi
            
            bundle_size=$(echo "$bundle_content" | wc -c)
            echo "  Bundle size: $bundle_size bytes"
            
            if [[ $bundle_size -lt $MIN_BUNDLE_SIZE ]]; then
              echo "‚ùå CA bundle too small ($bundle_size < $MIN_BUNDLE_SIZE bytes)"
              return 1
            fi
            
            cert_count=$(echo "$bundle_content" | grep -c "BEGIN CERTIFICATE" || echo "0")
            echo "  Certificate count: $cert_count"
            
            if [[ $cert_count -lt $MIN_CERTIFICATES ]]; then
              echo "‚ùå Too few certificates ($cert_count < $MIN_CERTIFICATES)"
              return 1
            fi
            
            hub_certs=$(echo "$bundle_content" | grep -c "hub" || echo "0")
            ocp_primary_certs=$(echo "$bundle_content" | grep -c "ocp-primary" || echo "0")
            ocp_secondary_certs=$(echo "$bundle_content" | grep -c "ocp-secondary" || echo "0")
            
            echo "  Hub cluster certificates: $hub_certs"
            echo "  ocp-primary certificates: $ocp_primary_certs"
            echo "  ocp-secondary certificates: $ocp_secondary_certs"
            
            if [[ $hub_certs -lt 2 || $ocp_primary_certs -lt 2 || $ocp_secondary_certs -lt 2 ]]; then
              echo "‚ùå Missing certificates from one or more clusters"
              return 1
            fi
            
            echo "‚úÖ CA bundle is complete and properly distributed"
            return 0
          }
          
          # Function to trigger certificate extraction
          trigger_certificate_extraction() {
            echo "Triggering certificate extraction..."
            
            oc delete job odf-ssl-certificate-extractor -n openshift-config --ignore-not-found=true
            sleep 5
            
            echo "Creating certificate extraction job..."
            oc apply -f - <<EOF
apiVersion: batch/v1
kind: Job
metadata:
  name: odf-ssl-certificate-extractor
  namespace: openshift-config
  labels:
    app.kubernetes.io/name: odf-ssl-certificate-management
    app.kubernetes.io/component: certificate-extraction
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  template:
    spec:
      containers:
      - name: odf-ssl-extractor
        image: registry.redhat.io/openshift4/ose-cli:latest
        resources:
          requests:
            memory: "512Mi"
            cpu: "200m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        command:
        - /bin/bash
        - -c
        - |
          set -euo pipefail
          
          echo "Starting ODF SSL certificate extraction and distribution..."
          echo "Following Red Hat ODF Disaster Recovery certificate management guidelines"
          
          WORK_DIR="/tmp/odf-ssl-certs"
          mkdir -p "$WORK_DIR"
          cd "$WORK_DIR"
          
          extract_cluster_ca() {
            cluster_name="$1"
            output_file="$2"
            kubeconfig="${3:-}"
            
            echo "Extracting CA from cluster: $cluster_name"
            
            if [[ -n "$kubeconfig" && -f "$kubeconfig" ]]; then
              KUBECONFIG="$kubeconfig" oc get configmap -n openshift-config-managed trusted-ca-bundle -o jsonpath="{.data['ca-bundle\.crt']}" > "$output_file"
              echo "  CA extracted from $cluster_name using kubeconfig"
            else
              oc get configmap -n openshift-config-managed trusted-ca-bundle -o jsonpath="{.data['ca-bundle\.crt']}" > "$output_file"
              echo "  CA extracted from $cluster_name using current context"
            fi
            
            cert_size=$(wc -c < "$output_file" 2>/dev/null || echo "0")
            echo "  Certificate size: $cert_size bytes"
            
            if [[ $cert_size -lt 1000 ]]; then
              echo "  Warning: Certificate size seems too small"
              return 1
            fi
            
            return 0
          }
          
          extract_ingress_ca() {
            cluster_name="$1"
            output_file="$2"
            kubeconfig="${3:-}"
            
            echo "Extracting ingress CA from cluster: $cluster_name"
            
            if [[ -n "$kubeconfig" && -f "$kubeconfig" ]]; then
              KUBECONFIG="$kubeconfig" oc get configmap -n openshift-config-managed router-ca -o jsonpath="{.data['ca-bundle\.crt']}" > "$output_file" 2>/dev/null || echo "" > "$output_file"
              echo "  Ingress CA extracted from $cluster_name using kubeconfig"
            else
              oc get configmap -n openshift-config-managed router-ca -o jsonpath="{.data['ca-bundle\.crt']}" > "$output_file" 2>/dev/null || echo "" > "$output_file"
              echo "  Ingress CA extracted from $cluster_name using current context"
            fi
            
            cert_size=$(wc -c < "$output_file" 2>/dev/null || echo "0")
            echo "  Ingress CA certificate size: $cert_size bytes"
            
            return 0
          }
          
          create_combined_ca_bundle() {
            output_file="$1"
            shift
            ca_files=("$@")
            
            echo "Creating combined CA bundle..."
            > "$output_file"
            
            file_count=0
            for ca_file in "${ca_files[@]}"; do
              if [[ -f "$ca_file" && -s "$ca_file" ]]; then
                echo "# CA from $(basename "$ca_file" .crt)" >> "$output_file"
                
                cert_count=0
                in_cert=false
                while IFS= read -r line; do
                  if [[ "$line" == "-----BEGIN CERTIFICATE-----" ]]; then
                    in_cert=true
                    cert_count=$((cert_count + 1))
                    if [[ $cert_count -gt 5 ]]; then
                      break
                    fi
                  fi
                  if [[ $in_cert == true ]]; then
                    echo "$line" >> "$output_file"
                  fi
                  if [[ "$line" == "-----END CERTIFICATE-----" ]]; then
                    in_cert=false
                    echo "" >> "$output_file"
                  fi
                done < "$ca_file"
                
                file_count=$((file_count + 1))
              fi
            done
            
            if [[ $file_count -gt 0 ]]; then
              echo "Combined CA bundle created with $file_count CA sources (first 5 certs each)"
              return 0
            else
              echo "No valid CA files found to combine"
              return 1
            fi
          }
          
          echo "1. Extracting hub cluster CA..."
          extract_cluster_ca "hub" ""
          extract_ingress_ca "hub" ""
          
          echo "2. Discovering managed clusters..."
          managed_clusters=$(oc get managedclusters -o jsonpath='{.items[*].metadata.name}' | tr ' ' '\n' | grep -v local-cluster || echo "")
          echo "  Found managed clusters: $managed_clusters"
          
          echo "  Added hub CA to bundle"
          echo "  Added hub ingress CA to bundle"
          
          cluster_count=0
          for cluster in $managed_clusters; do
            if [[ "$cluster" == "ocp-primary" || "$cluster" == "ocp-secondary" ]]; then
              cluster_count=$((cluster_count + 1))
              echo "3.$cluster_count Extracting CA from $cluster..."
              
              kubeconfig_file="/tmp/odf-ssl-certs/${cluster}-kubeconfig.yaml"
              oc get secret "${cluster}-import" -n "${cluster}" -o jsonpath="{.data.kubeconfig}" | base64 -d > "$kubeconfig_file" 2>/dev/null || {
                echo "  Warning: Could not get kubeconfig for $cluster"
                continue
              }
              
              extract_cluster_ca "$cluster" "$kubeconfig_file"
              extract_ingress_ca "$cluster" "$kubeconfig_file"
            fi
          done
          
          echo "4. Creating combined CA bundle..."
          ca_files=$(ls -1 *.crt 2>/dev/null | wc -l)
          echo "  CA files to combine: $ca_files files"
          
          for file in *.crt; do
            if [[ -f "$file" ]]; then
              file_size=$(wc -c < "$file" 2>/dev/null || echo "0")
              echo "    - $file ($file_size bytes)"
            fi
          done
          
          create_combined_ca_bundle "combined-ca-bundle.crt" *.crt
          
          bundle_size=$(wc -c < combined-ca-bundle.crt)
          cert_count=$(grep -c "BEGIN CERTIFICATE" combined-ca-bundle.crt || echo "0")
          
          echo "Combined CA bundle created with $ca_files CA sources (first 5 certs each)"
          echo "  Combined CA bundle created successfully"
          echo "  Bundle size: $bundle_size bytes"
          echo "  Certificate count: $cert_count"
          
          if [[ $bundle_size -lt 20000 ]]; then
            echo "‚ùå Combined CA bundle too small ($bundle_size < 20000 bytes)"
            exit 1
          fi
          
          if [[ $cert_count -lt 15 ]]; then
            echo "‚ùå Too few certificates in combined CA bundle ($cert_count < 15)"
            exit 1
          fi
          
          echo "5. Updating hub cluster ConfigMap..."
          oc create configmap cluster-proxy-ca-bundle \
            --from-file=ca-bundle.crt=combined-ca-bundle.crt \
            -n openshift-config \
            --dry-run=client -o yaml | oc apply -f -
          
          echo "  Hub cluster ConfigMap updated"
          
          echo "6. Updating hub cluster proxy configuration..."
          oc patch proxy/cluster --type=merge --patch='{"spec":{"trustedCA":{"name":"cluster-proxy-ca-bundle"}}}' || {
            echo "  Warning: Could not update hub cluster proxy"
          }
          
          echo "7. Distributing certificate data to managed clusters..."
          DISTRIBUTION_ATTEMPTS=3
          DISTRIBUTION_SLEEP=10
          
          for cluster in $MANAGED_CLUSTERS; do
            if [[ "$cluster" == "local-cluster" ]]; then
              continue
            fi
            
            echo "  Distributing to $cluster..."
            
            KUBECONFIG_FILE=""
            if oc get secret -n "$cluster" -o name | grep -E "(admin-kubeconfig|kubeconfig)" | head -1 | xargs -I {} oc get {} -n "$cluster" -o jsonpath='{.data.kubeconfig}' | base64 -d > "$WORK_DIR/${cluster}-kubeconfig.yaml" 2>/dev/null; then
              KUBECONFIG_FILE="$WORK_DIR/${cluster}-kubeconfig.yaml"
            fi
            
            if [[ -n "$KUBECONFIG_FILE" && -f "$KUBECONFIG_FILE" ]]; then
              distribution_success=false
              for dist_attempt in $(seq 1 $DISTRIBUTION_ATTEMPTS); do
                echo "    Distribution attempt $dist_attempt/$DISTRIBUTION_ATTEMPTS for $cluster..."
                
                if oc --kubeconfig="$KUBECONFIG_FILE" create configmap cluster-proxy-ca-bundle \
                  --from-file=ca-bundle.crt="$WORK_DIR/combined-ca-bundle.crt" \
                  -n openshift-config \
                  --dry-run=client -o yaml | oc --kubeconfig="$KUBECONFIG_FILE" apply -f -; then
                  
                  if oc --kubeconfig="$KUBECONFIG_FILE" patch proxy/cluster --type=merge --patch='{"spec":{"trustedCA":{"name":"cluster-proxy-ca-bundle"}}}'; then
                    echo "    ‚úÖ Certificate data distributed to $cluster (attempt $dist_attempt)"
                    distribution_success=true
                    break
                  else
                    echo "    ‚ö†Ô∏è  ConfigMap created but proxy update failed for $cluster (attempt $dist_attempt)"
                  fi
                else
                    echo "    ‚ö†Ô∏è  ConfigMap creation failed for $cluster (attempt $dist_attempt)"
                fi
                
                if [[ $dist_attempt -lt $DISTRIBUTION_ATTEMPTS ]]; then
                  echo "    ‚è≥ Waiting $DISTRIBUTION_SLEEP seconds before retry..."
                  sleep $DISTRIBUTION_SLEEP
                fi
              done
              
              if [[ "$distribution_success" != "true" ]]; then
                echo "    ‚ùå Failed to distribute certificate data to $cluster after $DISTRIBUTION_ATTEMPTS attempts"
                echo "    This may cause DR prerequisites check to fail"
              fi
            else
              echo "    ‚ùå Could not get kubeconfig for $cluster - skipping distribution"
            fi
          done
          
          echo "8. Verifying certificate distribution to managed clusters..."
          verification_failed=false
          for cluster in $MANAGED_CLUSTERS; do
            if [[ "$cluster" == "local-cluster" ]]; then
              continue
            fi
            
            echo "  Verifying distribution to $cluster..."
            KUBECONFIG_FILE="$WORK_DIR/${cluster}-kubeconfig.yaml"
            
            if [[ -f "$KUBECONFIG_FILE" ]]; then
              configmap_exists=$(oc --kubeconfig="$KUBECONFIG_FILE" get configmap cluster-proxy-ca-bundle -n openshift-config &>/dev/null && echo "true" || echo "false")
              configmap_size=$(oc --kubeconfig="$KUBECONFIG_FILE" get configmap cluster-proxy-ca-bundle -n openshift-config -o jsonpath='{.data.ca-bundle\.crt}' 2>/dev/null | wc -c || echo "0")
              proxy_configured=$(oc --kubeconfig="$KUBECONFIG_FILE" get proxy cluster -o jsonpath='{.spec.trustedCA.name}' 2>/dev/null || echo "")
              
              if [[ "$configmap_exists" == "true" && $configmap_size -gt 100 && "$proxy_configured" == "cluster-proxy-ca-bundle" ]]; then
                echo "    ‚úÖ $cluster: ConfigMap exists (${configmap_size} bytes), proxy configured"
              else
                echo "    ‚ùå $cluster: ConfigMap verification failed"
                echo "      ConfigMap exists: $configmap_exists"
                echo "      ConfigMap size: $configmap_size bytes"
                echo "      Proxy configured: $proxy_configured"
                verification_failed=true
              fi
            else
              echo "    ‚ùå $cluster: No kubeconfig available for verification"
              verification_failed=true
            fi
          done
          
          if [[ "$verification_failed" == "true" ]]; then
            echo ""
            echo "‚ö†Ô∏è  Certificate distribution verification failed for some clusters"
            echo "   This may cause DR prerequisites check to fail"
            echo "   Manual intervention may be required"
          else
            echo ""
            echo "‚úÖ All managed clusters verified successfully"
          fi
          
          echo ""
          echo "‚úÖ ODF SSL certificate management completed successfully!"
          echo "   - Hub cluster CA bundle: Updated (includes trusted CA + ingress CA)"
          echo "   - Hub cluster proxy: Configured"
          echo "   - Managed clusters: Certificate data distributed (includes ingress CAs)"
          echo ""
          echo "This follows Red Hat ODF Disaster Recovery certificate management guidelines"
          echo "for secure SSL access across clusters in the regional DR setup."
EOF
            
            echo "Certificate extraction job created"
            
            echo "Waiting for certificate extraction to complete..."
            attempt=0
            while [[ $attempt -lt $MAX_ATTEMPTS ]]; do
              attempt=$((attempt + 1))
              echo "  Attempt $attempt/$MAX_ATTEMPTS"
              
              if oc wait --for=condition=complete job/odf-ssl-certificate-extractor -n openshift-config --timeout=60s 2>/dev/null; then
                echo "  ‚úÖ Certificate extraction completed successfully"
                return 0
              else
                echo "  ‚è≥ Certificate extraction still running, waiting..."
                sleep $SLEEP_INTERVAL
              fi
            done
            
            echo "  ‚ùå Certificate extraction did not complete within expected time"
            return 1
          }
          
          # Main execution with retry logic
          main_execution() {
            echo "üîç Starting certificate distribution check with retry logic..."
          
            attempt=1
            while [[ $attempt -le $MAX_ATTEMPTS ]]; do
              echo "=== Certificate Distribution Attempt $attempt/$MAX_ATTEMPTS ==="
              
              if check_certificate_distribution; then
                echo "‚úÖ Certificate distribution is complete and verified"
                echo "   All clusters have proper CA bundles"
                echo "üéØ ODF SSL certificate precheck completed successfully"
                echo "   Ready for DR prerequisites check"
                exit 0
              else
                echo "‚ùå Certificate distribution is incomplete or missing"
                
                echo "üßπ Cleaning up placeholder ConfigMaps..."
                cleanup_placeholder_configmaps
                
                echo "   Triggering certificate extraction (attempt $attempt/$MAX_ATTEMPTS)..."
                
                if trigger_certificate_extraction; then
                  echo "‚úÖ Certificate extraction completed successfully"
                  echo "   Re-verifying distribution..."
                  
                  sleep 10
                  
                  if check_certificate_distribution; then
                    echo "‚úÖ Certificate distribution verified after extraction"
                    echo "üéØ ODF SSL certificate precheck completed successfully"
                    echo "   Ready for DR prerequisites check"
                    exit 0
                  else
                    echo "‚ö†Ô∏è  Certificate extraction completed but distribution still incomplete"
                    echo "   Will retry in $SLEEP_INTERVAL seconds..."
                  fi
                else
                  echo "‚ùå Certificate extraction failed (attempt $attempt/$MAX_ATTEMPTS)"
                  echo "   Will retry in $SLEEP_INTERVAL seconds..."
                fi
              fi
              
              if [[ $attempt -lt $MAX_ATTEMPTS ]]; then
                echo "‚è≥ Waiting $SLEEP_INTERVAL seconds before next attempt..."
                sleep $SLEEP_INTERVAL
              fi
              
              ((attempt++))
            done
            
            echo "‚ùå Certificate distribution failed after $MAX_ATTEMPTS attempts"
            echo "   This may affect DR prerequisites check"
            echo "   Manual intervention may be required"
            exit 1
          }
          
          # Call main execution
          main_execution