apiVersion: policy.open-cluster-management.io/v1beta1
kind: Policy
metadata:
  annotations:
    policy.open-cluster-management.io/categories: CA Assessment Authorization and
      Monitoring
    policy.open-cluster-management.io/controls: CA-7 Continuous Monitoring
    policy.open-cluster-management.io/standards: NIST SP 800-53
    argocd.argoproj.io/compare-options: IgnoreExtraneous
    argocd.argoproj.io/sync-options: Prune=false
    argocd.argoproj.io/health-check-ignore: "true"
    argocd.argoproj.io/hook: "Skip"
  labels:
    open-cluster-management.io/policy-set: openshift-plus
  name: policy-cluster-proxy-ca-distribution
  namespace: policies
spec:
  disabled: false
  policy-templates:
  - objectDefinition:
      apiVersion: policy.open-cluster-management.io/v1beta1
      kind: ConfigurationPolicy
      metadata:
        name: policy-cluster-proxy-ca-distribution
        annotations:
          argocd.argoproj.io/compare-options: IgnoreExtraneous
      spec:
        object-templates:
        - complianceType: musthave
          objectDefinition:
            apiVersion: batch/v1
            kind: Job
            metadata:
              name: distribute-cluster-proxy-ca
              namespace: openshift-config
              labels:
                app.kubernetes.io/name: cluster-proxy-ca
                app.kubernetes.io/component: ca-distribution
            spec:
              template:
                spec:
                  containers:
                  - name: ca-distributor
                    image: registry.redhat.io/openshift4/ose-cli:latest
                    command:
                    - /bin/bash
                    - -c
                    - |
                      set -euo pipefail
                      
                      echo "Starting cluster proxy CA distribution..."
                      
                      # Function to distribute CA bundle to a managed cluster
                      distribute_ca_to_cluster() {
                        local cluster_name="$1"
                        echo "Distributing CA bundle to cluster: $cluster_name"
                        
                        # Get the CA bundle from the hub cluster
                        local ca_bundle
                        ca_bundle=$(oc get configmap cluster-proxy-ca-bundle -n openshift-config -o jsonpath="{.data['ca-bundle\.crt']}" 2>/dev/null || echo "")
                        
                        if [[ -z "$ca_bundle" ]]; then
                          echo "Warning: No CA bundle found in hub cluster"
                          return 1
                        fi
                        
                        # Create the CA bundle ConfigMap in the managed cluster
                        echo "Creating CA bundle ConfigMap in $cluster_name..."
                        
                        # Use ACM to create the ConfigMap in the managed cluster
                        cat <<EOF | oc apply -f -
                      apiVersion: v1
                      kind: ConfigMap
                      metadata:
                        name: cluster-proxy-ca-bundle
                        namespace: openshift-config
                        labels:
                          app.kubernetes.io/name: cluster-proxy-ca
                          app.kubernetes.io/component: ca-bundle
                          cluster.open-cluster-management.io/type: managed
                      data:
                        ca-bundle.crt: |
                      $(echo "$ca_bundle" | sed 's/^/                          /')
                      EOF
                        
                        # Update the proxy resource in the managed cluster
                        echo "Updating proxy configuration in $cluster_name..."
                        oc patch proxy/cluster --type=merge --patch='{"spec":{"trustedCA":{"name":"cluster-proxy-ca-bundle"}}}' --context="$cluster_name" || {
                          echo "Warning: Could not update proxy in $cluster_name (may not be accessible from hub)"
                        }
                        
                        echo "CA bundle distributed to $cluster_name"
                        return 0
                      }
                      
                      # Function to create a policy that applies the ConfigMap to managed clusters
                      create_managed_cluster_policy() {
                        echo "Creating policy to apply CA bundle to managed clusters..."
                        
                        cat <<EOF | oc apply -f -
                      apiVersion: policy.open-cluster-management.io/v1beta1
                      kind: Policy
                      metadata:
                        name: policy-cluster-proxy-ca-bundle
                        namespace: policies
                        annotations:
                          policy.open-cluster-management.io/categories: CA Assessment Authorization and Monitoring
                          policy.open-cluster-management.io/controls: CA-7 Continuous Monitoring
                          policy.open-cluster-management.io/standards: NIST SP 800-53
                      spec:
                        disabled: false
                        policy-templates:
                        - objectDefinition:
                            apiVersion: policy.open-cluster-management.io/v1beta1
                            kind: ConfigurationPolicy
                            metadata:
                              name: policy-cluster-proxy-ca-bundle
                            spec:
                              object-templates:
                              - complianceType: musthave
                                objectDefinition:
                                  apiVersion: v1
                          kind: ConfigMap
                          metadata:
                            name: cluster-proxy-ca-bundle
                            namespace: openshift-config
                            labels:
                              app.kubernetes.io/name: cluster-proxy-ca
                              app.kubernetes.io/component: ca-bundle
                              cluster.open-cluster-management.io/type: managed
                          data:
                            ca-bundle.crt: |
                              # CA bundle will be populated by the hub cluster
                              # This ConfigMap contains the combined CA certificates
                              # from all clusters in the multicluster environment
                              # to enable secure communication through proxies
                              #
                              # The actual CA bundle content is managed by the hub cluster
                              # and synchronized to all managed clusters via this policy
                              #
                              # Placeholder for CA bundle content
                              -----BEGIN CERTIFICATE-----
                              # CA bundle content will be populated here
                              -----END CERTIFICATE-----
                              remediationAction: enforce
                              severity: high
                      EOF
                        
                        echo "Policy created for managed cluster CA bundle distribution"
                      }
                      
                      # Function to create a policy that updates proxy configuration
                      create_proxy_policy() {
                        echo "Creating policy to update proxy configuration in managed clusters..."
                        
                        cat <<EOF | oc apply -f -
                      apiVersion: policy.open-cluster-management.io/v1beta1
                      kind: Policy
                      metadata:
                        name: policy-cluster-proxy-config
                        namespace: policies
                        annotations:
                          policy.open-cluster-management.io/categories: CA Assessment Authorization and Monitoring
                          policy.open-cluster-management.io/controls: CA-7 Continuous Monitoring
                          policy.open-cluster-management.io/standards: NIST SP 800-53
                      spec:
                        disabled: false
                        policy-templates:
                        - objectDefinition:
                            apiVersion: policy.open-cluster-management.io/v1beta1
                            kind: ConfigurationPolicy
                            metadata:
                              name: policy-cluster-proxy-config
                            spec:
                              object-templates:
                              - complianceType: musthave
                                objectDefinition:
                                  apiVersion: config.openshift.io/v1
                                  kind: Proxy
                                  metadata:
                                    name: cluster
                                  spec:
                                    trustedCA:
                                      name: cluster-proxy-ca-bundle
                              remediationAction: enforce
                              severity: high
                      EOF
                        
                        echo "Policy created for managed cluster proxy configuration"
                      }
                      
                      # Main distribution logic
                      echo "Starting CA bundle distribution process..."
                      
                      # First, create the policies for managed clusters
                      create_managed_cluster_policy
                      create_proxy_policy
                      
                      # Get all managed clusters
                      MANAGED_CLUSTERS=$(oc get managedclusters -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo "")
                      
                      if [[ -n "$MANAGED_CLUSTERS" ]]; then
                        echo "Found managed clusters: $MANAGED_CLUSTERS"
                        
                        # Distribute CA bundle to each managed cluster
                        for cluster in $MANAGED_CLUSTERS; do
                          # Skip the local cluster if it's in the list
                          if [[ "$cluster" == "local-cluster" ]]; then
                            echo "Skipping local-cluster (hub)"
                            continue
                          fi
                          
                          echo "Processing managed cluster: $cluster"
                          
                          # Try to distribute CA bundle
                          if distribute_ca_to_cluster "$cluster"; then
                            echo "✓ CA bundle distributed to $cluster"
                          else
                            echo "✗ Failed to distribute CA bundle to $cluster"
                          fi
                        done
                      else
                        echo "No managed clusters found"
                      fi
                      
                      # Also handle regional DR clusters specifically
                      echo "Checking for regional DR clusters..."
                      for cluster in ocp-primary ocp-secondary; do
                        if oc get managedcluster "$cluster" >/dev/null 2>&1; then
                          echo "Found regional DR cluster: $cluster"
                          if distribute_ca_to_cluster "$cluster"; then
                            echo "✓ CA bundle distributed to regional DR cluster $cluster"
                          else
                            echo "✗ Failed to distribute CA bundle to regional DR cluster $cluster"
                          fi
                        fi
                      done
                      
                      echo "CA bundle distribution completed"
                    env:
                    - name: KUBECONFIG
                      value: "/var/run/secrets/kubernetes.io/serviceaccount/..data/token"
                  restartPolicy: Never
                  serviceAccountName: ca-distributor-sa
              backoffLimit: 3
        - complianceType: musthave
          objectDefinition:
            apiVersion: v1
            kind: ServiceAccount
            metadata:
              name: ca-distributor-sa
              namespace: openshift-config
              labels:
                app.kubernetes.io/name: cluster-proxy-ca
                app.kubernetes.io/component: ca-distribution
        - complianceType: musthave
          objectDefinition:
            apiVersion: rbac.authorization.k8s.io/v1
            kind: ClusterRole
            metadata:
              name: ca-distributor-role
              labels:
                app.kubernetes.io/name: cluster-proxy-ca
                app.kubernetes.io/component: ca-distribution
            rules:
            - apiGroups: [""]
              resources: ["configmaps"]
              verbs: ["get", "list", "create", "update", "patch"]
            - apiGroups: ["config.openshift.io"]
              resources: ["proxies"]
              verbs: ["get", "patch"]
            - apiGroups: ["cluster.open-cluster-management.io"]
              resources: ["managedclusters"]
              verbs: ["get", "list"]
            - apiGroups: ["policy.open-cluster-management.io"]
              resources: ["policies"]
              verbs: ["get", "list", "create", "update", "patch"]
        - complianceType: musthave
          objectDefinition:
            apiVersion: rbac.authorization.k8s.io/v1
            kind: ClusterRoleBinding
            metadata:
              name: ca-distributor-rolebinding
              labels:
                app.kubernetes.io/name: cluster-proxy-ca
                app.kubernetes.io/component: ca-distribution
            subjects:
            - kind: ServiceAccount
              name: ca-distributor-sa
              namespace: openshift-config
            roleRef:
              kind: ClusterRole
              name: ca-distributor-role
              apiGroup: rbac.authorization.k8s.io
        remediationAction: enforce
        severity: high
