apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  annotations:
    policy.open-cluster-management.io/categories: CA Assessment Authorization and
      Monitoring
    policy.open-cluster-management.io/controls: CA-7 Continuous Monitoring
    policy.open-cluster-management.io/standards: NIST SP 800-53
    argocd.argoproj.io/compare-options: IgnoreExtraneous
    argocd.argoproj.io/sync-options: Prune=false
    argocd.argoproj.io/health-check-ignore: "true"
    argocd.argoproj.io/hook: "PostSync"
    argocd.argoproj.io/sync-wave: "2"
  labels:
    open-cluster-management.io/policy-set: openshift-plus
  name: policy-ocm-observability
  namespace: open-cluster-management
spec:
  disabled: false
  policy-templates:
  - objectDefinition:
      apiVersion: policy.open-cluster-management.io/v1
      kind: ConfigurationPolicy
      metadata:
        name: policy-ocm-observability
        annotations:
          argocd.argoproj.io/compare-options: IgnoreExtraneous
      spec:
        object-templates:
        - complianceType: musthave
          objectDefinition:
            apiVersion: v1
            kind: ConfigMap
            metadata:
              name: observability-config
              namespace: open-cluster-management-observability
            data:
              enabled: "true"
        - complianceType: musthave
          objectDefinition:
            apiVersion: v1
            kind: Secret
            metadata:
              name: observability-storage-secret
              namespace: open-cluster-management-observability
            type: Opaque
            data:
              access_key: ""
              secret_key: ""
        - complianceType: musthave
          objectDefinition:
            apiVersion: v1
            kind: Namespace
            metadata:
              name: open-cluster-management-observability
              labels:
                app.kubernetes.io/name: observability
                app.kubernetes.io/component: namespace
        - complianceType: musthave
          objectDefinition:
            apiVersion: v1
            kind: ServiceAccount
            metadata:
              name: observability-controller-sa
              namespace: open-cluster-management-observability
        - complianceType: musthave
          objectDefinition:
            apiVersion: rbac.authorization.k8s.io/v1
            kind: ClusterRole
            metadata:
              name: observability-controller-role
            rules:
            - apiGroups: ["observability.open-cluster-management.io"]
              resources: ["multiclusterobservabilities"]
              verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
            - apiGroups: [""]
              resources: ["namespaces", "secrets", "configmaps"]
              verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
        - complianceType: musthave
          objectDefinition:
            apiVersion: rbac.authorization.k8s.io/v1
            kind: ClusterRoleBinding
            metadata:
              name: observability-controller-rolebinding
            subjects:
            - kind: ServiceAccount
              name: observability-controller-sa
              namespace: open-cluster-management-observability
            roleRef:
              kind: ClusterRole
              name: observability-controller-role
              apiGroup: rbac.authorization.k8s.io
        - complianceType: musthave
          objectDefinition:
            apiVersion: observability.open-cluster-management.io/v1beta2
            kind: MultiClusterObservability
            metadata:
              name: observability
              namespace: open-cluster-management-observability
            spec:
              observabilityAddonSpec:
                enableMetrics: true
                interval: 30
              advanced:
                retentionConfig:
                  retentionResolutionRaw: 5d
                  retentionResolution5m: 10d
                  retentionResolution1h: 1y
              nodeSelector:
                node-role.kubernetes.io/worker: ""
              tolerations:
              - key: node-role.kubernetes.io/master
                operator: Exists
                effect: NoSchedule
        remediationAction: enforce
        severity: medium
